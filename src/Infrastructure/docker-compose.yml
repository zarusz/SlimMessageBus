version: "3.4"

services:
  zookeeper:
    container_name: slim.zookeeper
    image: confluentinc/cp-zookeeper:7.8.0
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - slim

  kafka:
    image: confluentinc/cp-kafka:7.8.0
    container_name: slim.kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181

      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,PLAINTEXT_HOST://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://slim.kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT

      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_NUM_PARTITIONS: 2
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
    depends_on:
      - zookeeper
    networks:
      - slim

  kafka-init:
    image: confluentinc/cp-kafka:7.8.0
    container_name: slim.kafka-init
    depends_on:
      - kafka
    networks:
      - slim
    entrypoint: ["/bin/sh", "-c"]
    command: |
      "
      # Wait for Kafka to be ready
      echo 'Waiting for Kafka to be ready...'
      cub kafka-ready -b slim.kafka:29092 1 60

      # Create topics
      echo 'Creating topics...'
      kafka-topics --create --if-not-exists --topic test-ping --partitions 2 --replication-factor 1 --bootstrap-server slim.kafka:29092
      kafka-topics --create --if-not-exists --topic test-echo --partitions 2 --replication-factor 1 --bootstrap-server slim.kafka:29092
      kafka-topics --create --if-not-exists --topic test-echo-resp --partitions 2 --replication-factor 1 --bootstrap-server slim.kafka:29092

      echo 'Topics created successfully'
      "

  mqtt:
    container_name: slim.mqtt
    image: eclipse-mosquitto:2.0.22
    ports:
      - "1883:1883" #default mqtt port
      - "9001:9001" #default mqtt port for websockets
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf
    networks:
      - slim

  psqldb:
    container_name: slim.psql
    image: postgres:17.7
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=SecretP@55word
    ports:
      - 5432:5432
    networks:
      - slim

  rabbitmq:
    container_name: slim.rabbitmq
    image: rabbitmq:4.2.3-management-alpine
    ports:
      - 5672:5672
      - 15672:15672 # user/pass: guest/guest
    networks:
      - slim

  redis:
    container_name: slim.redis
    image: redis:8.4
    ports:
      - 6379:6379
    networks:
      - slim

  sqldb:
    container_name: slim.sql
    image: mcr.microsoft.com/mssql/server:2022-CU21-ubuntu-22.04
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=SuperSecretP@55word
    ports:
      - 1433:1433
    networks:
      - slim

  storage:
    container_name: slim.storage
    image: mcr.microsoft.com/azure-storage/azurite:3.33.0
    command: "azurite --blobHost 0.0.0.0 --blobPort 11000 --queueHost 0.0.0.0 --queuePort 11001 --tableHost 0.0.0.0 --tablePort 11002 --location /data"
    environment:
      - AZURITE_ACCOUNTS=devstoreaccount1:Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;
    ports:
      - "11000:11000"
      - "11001:11001"
      - "11002:11002"
    networks:
      - slim

  nats:
    container_name: slim.nats
    image: nats:2.12.4
    ports:
      - 4222:4222
    networks:
      - slim

networks:
  slim: {}
